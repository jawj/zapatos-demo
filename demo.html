<!DOCTYPE html>
<html>

<head>
  <title>zapatos-demo</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
  <div id="container" style="width: 960px; height: 300px; border: 1px solid #ddd;"></div>

  <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
  <script src="./files.js"></script>
  <script>
    const js =
        `import * as db from './zapatos/src';
import * as s from './zapatos/schema';
import { pool } from './pgPool';

(async () => {

    // 0. a command-line tool interrogates your Postgres database and generates detailed TypeScript types for every enum and table

    // 1. simple building blocks help you write SQL and apply the appropriate types, by hand, to what goes in and what comes back

    // (a) INSERT using cols and vals helpers
    const
      author: s.authors.Insertable = {
        name: 'Gabriel Garcia Marquez',
        isLiving: false,
      },
      [insertedAuthor] = await db.sql<s.authors.SQL, s.authors.Selectable[]>\`
          INSERT INTO \${"authors"} (\${db.cols(author)})
          VALUES(\${db.vals(author)}) RETURNING * \`
        .run(pool);

    console.log(insertedAuthor.id);

    // (b) SELECT using a Whereable, self and (manual) param
    const 
      searchTerm = 'marquez',  // could be untrusted 
      likePattern = \`%\${searchTerm}%\`,
      [firstFoundAuthor] = await db.sql<s.authors.SQL, s.authors.Selectable[]>\`
        SELECT * FROM \${"authors"} WHERE \${{
          isLiving: false,
          name: db.sql<db.SQL>\`\${db.self} ILIKE \${db.param(likePattern)}\`,
        }}\`
      .run(pool);
    
    console.log(firstFoundAuthor?.name);


    // 2. shortcut functions generate basic, single-table INSERT/SELECT/UPDATE/DELETE/TRUNCATE queries, fully and automatically typed going in and coming out
    
    // (a) Multiple INSERT
    const insertedAuthors = await db.insert("authors", [
      { name: "Gabriel Garcia Marquez", isLiving: false }, 
      { name: "Douglas Adams", isLiving: false }
    ]).run(pool);

    // (b) Basic SELECT
    const books = await db.select('books', { authorId: 10 }).run(pool);
    books.map(b => b.title);


    // 3. SELECT shortcuts can be nested to generate arbitrarily complex LATERAL JOIN queries, producing nested JSON structures, all still automatically typed

    // (a) Nested SELECT with many-to-one (author) and many-to-many (tags) join
    const bookAuthorTags = await db.select('books', db.all, {
      lateral: {
        author: db.selectOne('authors', { id: db.parent('authorId') }),
        tags: db.select('tags', { bookId: db.parent('id') }),
      }
    }).run(pool);

    bookAuthorTags.map(b => b.author?.name);
    
    // (b) Nested SELECT two levels deep
    const authorsBooksTags = await db.select('authors', db.all, {
      lateral: {
        books: db.select('books', { authorId: db.parent('id') }, {
          lateral: {
            tags: db.select('tags', { bookId: db.parent('id') })
          }
        })
      }
    }).run(pool);

})();
`;

    require.config({ paths: { 'vs': './node_modules/monaco-editor/min/vs' } });
    require(['vs/editor/editor.main'], async function () {

      const 
        ts = monaco.languages.typescript,
        tsDefs = ts.typescriptDefaults;

      tsDefs.setCompilerOptions({ strict: true, target: ts.ScriptTarget.ES2015 });
      for (const file in files) tsDefs.addExtraLib(files[file], `file:///${file}`);

      const 
        uri = monaco.Uri.parse('file:///main.ts'),
        model = monaco.editor.createModel(js, 'typescript', uri),
        opts = { model, minimap: { enabled: false } },
        editor = monaco.editor.create(document.getElementById('container'), opts);

      /*
      const
        worker = await ts.getTypeScriptWorker(),
        client = await worker(model.uri),
        emitOutput = await client.getEmitOutput(model.uri.toString()),
        compiledScript = emitOutput.outputFiles[0].text;
        
      console.log(compiledScript);
      */

      window.editor = editor;
    });
  </script>
</body>

</html>